<!DOCTYPE html>
<html lang="pt_BR">
    <head>
        <title></title>
        <meta charset="utf-8"/>
        <title>Duplicar um banco oracle na mesma máquina</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">

        <!--link href="https://fonts.googleapis.com/css?family=Lato:400,900" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet" type="text/css"-->
        <link rel="alternate" type="application/atom+xml" title="Vivendo e Aprendendo (Atom)" href="/feed.xml" />
        <link href="../../css/default.css" rel="stylesheet">
        <!--link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css" -->
        <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">  
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>        
        <script>hljs.initHighlightingOnLoad();</script>
        <!-- Google -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PJEKKSQ2FT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PJEKKSQ2FT');
</script>
<script data-ad-client="ca-pub-3863943400063116" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>        <link rel="shortcut icon" href="../../favicon.ico">
        <!-- https://www.osano.com/cookieconsent/download/ -->
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
    </head>
    <body>
	
<header>
	<hgroup>
		<h1><a href="/">Vivendo e Aprendendo</a></h1>
		<h2>Experiência prática na administração de Banco de Dados</h2>
	</hgroup>
</header>
<nav>
<menu>
	<a href="../../index.html">Home</a>
	<a href="../../archive.html">All posts</a>
	<a href="../../about.html">About me</a>
	<a href="../../feeds/posts/default.xml">Atom feed</a>
	</menu>
</nav>
<section>
<article>
    <header>
        <h1>Duplicar um banco oracle na mesma máquina</h1>
        <p>by <em>Gilberto C. Andrade</em> on <strong>01 dezembro 2008</strong></p>
        <p>Tagged as: 
            <a href="../../tags/Database.html">Database</a>,
            <a href="../../tags/Oracle.html">Oracle</a>,
        </p>
    </header>
    <section>
	<div class="paragraph">
<p>Atualmente aqui na <a href="https://www.secad.to.gov.br">Secretaria</a> estamos em um processo de
implantação de um <a href="https://www.techne.com.br/produtos/produtos.asp?id=4">sistema de recursos humanos</a>,
para ser mais exato, praticamente toda parte de infraestrutura (hardware e software)
já está pronta para uso. Mas por questões que foge ao meu conhecimento (penso
ser licitação), a fase mais densa (treinamento e uso pelo usuário final) está
em fase de planejamento/reestruturação. Bom, apesar dessa, vamos dizer
morosidade, tem uma fase desse processo que não pára: a migração. Nesse processo
participam duas equipes: parametrização e a própria migração, o qual nessa
última pertenço.</p>
</div>
<div class="paragraph">
<p>A migração é um ciclo constante onde a partir de modificações(parametrização)
importantes no banco de produção, é acionado uma requisição de atualização do
banco de migração (utilizado para validar a parametrização com a ativação de
funções do sistema de recursos humanos, por exemplo, calculo de folha). Para
esse ciclo funcionar tive que realizar uma das tarefas mais comuns para quem
administra um que é cópia/duplicação/clonagem de um banco em
produção para outro banco (até mesmo em outro servidor) a ser utilizado como
teste. O procedimento descrito aqui, nada mais é do que sequência descrita na
própria <a href="http://download.oracle.com/docs/cd/B19306_01/backup.102/b14191/rcmdupdb.htm#i1006474">documentação</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an Oracle Password File for the Auxiliary Instance <a href="#task1">[task1]</a></p>
</li>
<li>
<p>Establish Oracle Net Connectivity to the Auxiliary Instance <a href="#task2">[task2]</a></p>
</li>
<li>
<p>Create an Initialization Parameter File for the Auxiliary Instance <a href="#task3">[task3]</a></p>
</li>
<li>
<p>Start the Auxiliary Instance <a href="#task4">[task4]</a></p>
</li>
<li>
<p>Mount or Open the Target Database <a href="#task5">[task5]</a></p>
</li>
<li>
<p>Make Sure You Have the Necessary Backups and Archived Redo Logs(Essencial - você precisa de um backup <a href="#task6">[task6]</a></p>
</li>
<li>
<p>Allocate Auxiliary Channels if Automatic Channels Are Not Configured <a href="#task7">[task7]</a></p>
</li>
<li>
<p>Recrie a tablespace temporária (extra) <a href="#task8">[task8]</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_task_1_create_an_oracle_password_file_for_the_auxiliary_instance"><a id="task1"></a>Task 1: Create an Oracle Password File for the Auxiliary Instance</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">cd $ORACLE_HOME/dbs/
orapwd file=$ORACLE_HOME/dbs/orapwbeta password=senha entries=5</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_2_establish_oracle_net_connectivity_to_the_auxiliary_instance"><a id="task2"></a>Task 2: Establish Oracle Net Connectivity to the Auxiliary Instance</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">vi $ORACLE_HOME/network/admin/tnsnames.ora
BETA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm.secad)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = beta.secad.to.gov.br)
    )
  )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
a criação estática de um listener é importantíssima, caso contrário
vc encontrá problemas de conexão, como o erro:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>ORA-12528: TNS:listener: all appropriate instances are blocking new connections</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Shell
vi $ORACLE_HOME/network/admin/listener.ora
# listener.ora Network Configuration File:
/opt/oracle/db/10.2.0.1.0/server/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = producao.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = producao)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = alfa.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = alfa)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = beta.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = beta)
    )
  )

LISTENER =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm)(PORT = 1521))
  )</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_3_create_an_initialization_parameter_file_for_the_auxiliary_instance"><a id="task3"></a>Task 3: Create an Initialization Parameter File for the Auxiliary Instance</h3>
<div class="paragraph">
<p>Vamos criar primeiro a estrutura de diretorios onde ficarão os arquivos do banco</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">cd /dm0/oracle/admin/beta
mkdir adump
mkdir arch
mkdir bdump
mkdir cdump
mkdir data
mkdir exp
mkdir pfile
mkdir scripts
mkdir udump
mkdir utlfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>Agora o arquivo de inicialização, para isso vou fazer uma copia do banco
original e fazer a mudanças necessárias</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">cd /dm0/oracle/admin/beta/pfile/
cp ../../producao/pfile/init.ora.292007145712 initbeta.ora
vi initbeta.ora</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se estiver usando spfile no banco original, crie um arquivo de inicialização
(pfile) a partir dele</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">export ORACLE_SID=producao
sqlplus /as sysdba
CREATE PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora' FROM SPFILE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Substitua todas as ocorrências do banco anterior</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">:g/producao/s//beta/g

#Acrescente mais uma seção neste arquivo
###########################################
#  Filename Conversion Initialization Parameters
#  Renaming Datafiles in RMAN DUPLICATE DATABASE
#  Renaming Online Logs in RMAN DUPLICATE DATABASE
###########################################
DB_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data/,/dm0/oracle/admin/beta/data/)
LOG_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data,/dm0/oracle/admin/beta/data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Salve o arquivo. Para facilitar a duplicação recomenda-se criar um spfile no
local padrao da instalação. Isso irá lhe poupar o trabalho quando o rman fizer
o shutdwon e startup, ele não solicitará o arquivo de inicialização pfile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">export ORACLE_SID=beta
sqlplus /as sysdba
CREATE SPFILE FROM PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora';</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_4_start_the_auxiliary_instance"><a id="task4"></a>Task 4: Start the Auxiliary Instance</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">export ORACLE_SID=beta
sqlplus /as sysdba
STARTUP FORCE NOMOUNT</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_5_mount_or_open_the_target_database_opcional_provavelmente_o_banco_original_já_esteja_aberto"><a id="task5"></a>Task 5: Mount or Open the Target Database (Opcional - provavelmente o banco original já esteja aberto!)</h3>
<div class="paragraph">
<p>Conecte-se ao banco de origem</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">SQL&gt; CONNECT SYS/oracle@producao AS SYSDBA;

STARTUP MOUNT;#mount or open database origem</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_6_make_sure_you_have_the_necessary_backups_and_archived_redo_logs_essencial_você_precisa_de_um_backup_recente_caso"><a id="task6"></a>Task 6: Make Sure You Have the Necessary Backups and Archived Redo Logs (Essencial - você precisa de um backup recente, caso</h3>
<div class="paragraph">
<p>contrário, a clonagem criará um banco antigo)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">export ORACLE_SID=producao
rman target /
Recovery Manager: Release 10.2.0.2.0 - Production on Wed Mar 14 18:12:58 2007
Copyright (c) 1982, 2005, Oracle.  All rights reserved.
connected to target database: PRODUCAO (DBID=2991538920)
RMAN&gt; list backup;
using target database control file instead of recovery catalog
List of Backup Sets
===================</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_7_allocate_auxiliary_channels_if_automatic_channels_are_not_configured"><a id="task7"></a>Task 7: Allocate Auxiliary Channels if Automatic Channels Are Not Configured</h3>
<div class="paragraph">
<p>Start RMAN with a connection to the target database, the auxiliary instance,
and, if applicable, the recovery catalog database
Nesta conexão pode ocorrer um error comum na versao 10g:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>ORA-12528: TNS:listener: all appropriate instances are blocking new connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este é um erro conhecido do Oracle 10g onde um SHUTDOWN IMMEDIATE é seguido
por um STARTUP MOUNT ou STARTUP FORCE MOUNT. Execute um novo SHUTDOWN no banco
e então um STARTUP. Você será capaz de conectar novamente.
Se ainda sim você não conseguir conectar, inverta as opções do rman:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">#Forma alternativa
oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt; export ORACLE_SID=beta
oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt;rman target sys@producao auxiliary /</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt; export ORACLE_SID=producao
oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt; rman TARGET /  AUXILIARY SYS@beta

Recovery Manager: Release 10.2.0.2.0 - Production on Thu Mar 15 09:03:41 2007

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

connected to target database: PRODUCAO (DBID=2991538920)
auxiliary database Password:
connected to auxiliary database: BETA (not mounted)

RMAN&gt;
RUN
{
  # to manually allocate a channel of type sbt issue:
  #ALLOCATE AUXILIARY CHANNEL ch1 DEVICE TYPE sbt;

  # to manually allocate two auxiliary channels for disk issue (specifying whatever channel id that you want):
  ALLOCATE AUXILIARY CHANNEL aux1 DEVICE TYPE DISK;
  ALLOCATE AUXILIARY CHANNEL aux2 DEVICE TYPE DISK;
  DUPLICATE TARGET DATABASE TO beta;
}
.
.
.
contents of Memory Script:
{
   Alter clone database open resetlogs;
}
executing Memory Script

database opened
Finished Duplicate Db at 15/03/2007 09:55:47

RMAN&gt; quit</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_8_recrie_a_tablespace_temporária_extra"><a id="task8"></a>Task 8: Recrie a tablespace temporária (extra)</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">#(versão 9i e acima)
ALTER DATABASE TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf' DROP INCLUDING
DATAFILES;
ALTER TABLESPACE TEMP ADD TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf'
SIZE 200M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE 2000M;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Outra coisa, como este banco é para teste, devemos desabilitar o modo archive
do mesmo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt; export ORACLE_SID=beta
oracle@oracleibm:/dm0/oracle/admin/beta/pfile&gt; sqlplus / as sysdba
SQL&gt; archive log list
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch
Oldest online log sequence     0
Next log sequence to archive   1
Current log sequence           1

SQL&gt; shutdown immediate
Database closed.
Database dismounted.
ORACLE instance shut down.

SQL&gt; startup mount
ORACLE instance started.
Total System Global Area 1811939328 bytes
Fixed Size                  2071896 bytes
Variable Size             419431080 bytes
Database Buffers         1375731712 bytes
Redo Buffers               14704640 bytes
Database mounted.

SQL&gt; alter database noarchivelog;
Database altered.

SQL&gt; alter database open;
Database altered.

SQL&gt; archive log list
Database log mode              No Archive Mode
Automatic archival             Disabled
Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch
Oldest online log sequence     0
Current log sequence           1
SQL&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>[NOTE] Não esquecer de coletar estatísticas</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="Shell">begin
dbms_stats.gather_database_stats(options=&gt; 'GATHER AUTO');
end;</code></pre>
</div>
</div>
</div>
    </section>
<section>
<div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'blog-gilbertoca-com';
            var disqus_identifier = '10';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
</article>
	
</section>
    <footer>
        <p>
            <a href="https://pages.github.com/">Hosted by GitHub Pages</a> -
            <a href="https://jbake.org/">Generated with JBake</a> -
            <a href="https://github.com/gilbertoca/gilbertoca.com">Source code</a>
        </p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
    <script>
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#eaf7f7",
          "text": "#5c7291"
        },
        "button": {
          "background": "#56cbdb",
          "text": "#ffffff"
        }
      },
      "content": {
        "message": "Este site usa cookies do Google para fornecer seus serviços, personalizar anúncios e analisar o tráfego. Informações sobre seu uso deste site são compartilhadas com o Google. Ao utilizar este site, você concorda com o uso de cookies.",
        "dismiss": "Concordo!",
        "link": "Saiba mais",
        "href": "https://policies.google.com/technologies/cookies"
      }
    });
    </script>
</body>
</html>
